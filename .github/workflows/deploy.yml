name: Deploy Multi-Service App (Docker Compose)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check Docker setup
        run: |
          echo "=== Docker Setup Check ==="
          docker --version || echo "Docker not found"
          docker compose version || echo "Docker Compose not found"
          ls -la /var/run/docker.sock 2>/dev/null || echo "Docker socket not found"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx  # Важно: добавить id для ссылки

      - name: Show Buildx info
        run: |
          echo "=== Buildx Information ==="
          docker buildx version
          docker buildx ls
          docker buildx inspect

      - name: Build and start services
        run: |
          echo "=== Building and starting services ==="
          # Пробуем без sudo, потом с sudo если нужно
          docker compose up --build -d || sudo docker compose up --build -d
          sleep 5

      - name: Verify deployment
        run: |
          echo "=== Running containers ==="
          docker ps -a || sudo docker ps -a
          echo "=== Compose services ==="
          docker compose ps || sudo docker compose ps